<html>
  <head>
    <title>DTMF Simulator</title>
    <style>
      body {
          background: #ccc;
      }

      #content {
          background: #fff;
          width: 340px;
          margin: auto;
          padding: 20px;
          border-radius: 15px;
      }

      button {
          width: 80px;
          height: 80px;
          margin: 2px 0px;
          font-size: 30px;
          color: #444;

          border-style: outset;
          border-width: 10px;
          border-radius: 10px;

          background: #D8D8D8;
          border-color: #EEE;
      }

      button:hover {
          background: #AAA;
          border-color: #CCC;
      }

      button:active, button:focus {
          background: #888;
          border-color: #aaa;
      }

      .special {
          background: #f00;
          border-color: #f66;
          color: #fff;
      }

      .special:hover {
          background: #D00;
          border-color: #E44;
      }

      .special:active, special:focus {
          background: #B00;
          border-color: #D22;
      }

      .wide {
          width: 164px;
          font-size: 20px;
      }

      canvas {
          border: 1px solid black;
      }

      h1 {
          margin: 0px;
      }

    </style>
  </head>
  <body>
    <div id="content">
      <p>
        <h1>DTFM Simulator</h1>
        <i>Dual-tone multi-frequency signaling</i>
      </p>
      <button id="1">1</button>
      <button id="2">2</button>
      <button id="3">3</button>
      <button class="special" id="a">A</button>
      <br>
      <button id="4">4</button>
      <button id="5">5</button>
      <button id="6">6</button>
      <button class="special" id="b">B</button>
      <br>
      <button id="7">7</button>
      <button id="8">8</button>
      <button id="9">9</button>
      <button class="special" id="c">C</button>
      <br>
      <button id="*">*</button>
      <button id="0">0</button>
      <button id="#">#</button>
      <button class="special" id="d">D</button>
      <br>
      <button id="dial" class="wide">Dial Tone</button>
      <button id="ring" class="wide">Ring Tone</button>
      <br>
      <button id="busy" class="wide">Busy Signal</button>
      <button id="error" class="wide">Error</button>

      <p>Multi-frequency signaling is a group of signaling methods that use a mixture of two pure sine waves. The DTMF system uses a set of eight audio frequencies transmitted in pairs to represent 16 signals. 
        </p>

      <canvas id="canvas" width="340" height="256"></canvas>
      <br>
      Tone 1: <span id="tone1">--Hz</span>
      <br>
      Tone 2: <span id="tone2">--Hz</span>
      <br>
      Beat Frequency: <span id="beat">--Hz</span>
    </div>
  </body>
  <script>

    let ctx = new AudioContext();

    let oscillator1 = ctx.createOscillator();
    let gainNode1 = ctx.createGain();
    oscillator1.connect(gainNode1);
    gainNode1.connect(ctx.destination);

    let oscillator2 = ctx.createOscillator();
    let gainNode2 = ctx.createGain();
    oscillator2.connect(gainNode2);
    gainNode2.connect(ctx.destination);

    let active = false;

    let tones = {
        "1" : [1209, 697],
        "2" : [1336, 697],
        "3" : [1477, 697],
        "a" : [1633, 697],
        "4" : [1209, 770],
        "5" : [1336, 770],
        "6" : [1477, 770],
        "b" : [1633, 770],
        "7" : [1209, 852],
        "8" : [1336, 852],
        "9" : [1477, 852],
        "c" : [1633, 852],
        "*" : [1209, 941],
        "0" : [1336, 941],
        "#" : [1477, 941],
        "d" : [1633, 941],
    };

    function play_tones(a, b) {
        oscillator1.frequency.setValueAtTime(a, ctx.currentTime);
        oscillator2.frequency.setValueAtTime(b, ctx.currentTime);
        toggle(true);
        update_oscilloscope(a, b);
    }

    function press_button(b) {
        play_tones(tones[b][0], tones[b][1]);
        //document.getElementById(b).focus();
    }

    function toggle(on){
        if (!active) {
            oscillator1.start(0);
            oscillator2.start(0);
            active = true;
        }

        if (on) {
            ctx.resume();
            gainNode1.gain.setValueAtTime(1, ctx.currentTime);
            gainNode2.gain.setValueAtTime(1, ctx.currentTime);
        } else {
            gainNode1.gain.setValueAtTime(0, ctx.currentTime);
            gainNode2.gain.setValueAtTime(0, ctx.currentTime);
            // Set focus then blur on something else
            //document.getElementById("1").focus();
            //document.getElementById("1").blur();
        }
    };

    let timeout;
    function play_error(s) {
        let delay;
        if (s == 0) {
            play_tones(913.8, 0);
            delay = 274;
        }
        if (s == 1) {
            play_tones(1370.6, 0);
            delay = 274;
        }
        if (s == 3) {
            play_tones(1776.7, 0);
            delay = 380;
        }
        if (s == 4) {
            toggle(false);
        }

        timeout = setTimeout(() => play_error(s+1), delay);
    }

    class button {
        constructor(element, down_action, up_action) {
            this.down_action = down_action;
            this.up_action = up_action;
            this.element = element;

            this.element.addEventListener("mousedown",  (event) => this.perform_action(event) );
            this.element.addEventListener("mouseup",    (event) => this.up_action() );
            this.element.addEventListener("mouseout",   (event) => this.up_action() );

            this.element.addEventListener("touchstart", (event) => this.perform_action(event) );
            this.element.addEventListener("touchend",   (event) => this.up_action() );
        }
        perform_action(e) {
            e.preventDefault();
            this.down_action();
        }
      }

    let buttons = [];

    /*
    for (key in tones){
        buttons.push(new button(document.getElementById(key), () => play_tones(tones[key][0], tones[key][1]), () => toggle(false)));
        console.log(key, tones[key][0], tones[key][1]);
    }
    */

    let button_one   = new button(document.getElementById("1"), () => play_tones(1209, 697), () => toggle(false));
    let button_two   = new button(document.getElementById("2"), () => play_tones(1336, 697), () => toggle(false));
    let button_three = new button(document.getElementById("3"), () => play_tones(1477, 697), () => toggle(false));
    let button_a     = new button(document.getElementById("a"), () => play_tones(1633, 697), () => toggle(false));

    let button_four  = new button(document.getElementById("4"), () => play_tones(1209, 770), () => toggle(false));
    let button_five  = new button(document.getElementById("5"), () => play_tones(1336, 770), () => toggle(false));
    let button_six   = new button(document.getElementById("6"), () => play_tones(1477, 770), () => toggle(false));
    let button_b     = new button(document.getElementById("b"), () => play_tones(1633, 770), () => toggle(false));

    let button_seven = new button(document.getElementById("7"), () => play_tones(1209, 852), () => toggle(false));
    let button_eight = new button(document.getElementById("8"), () => play_tones(1336, 852), () => toggle(false));
    let button_nine  = new button(document.getElementById("9"), () => play_tones(1477, 852), () => toggle(false));
    let button_c     = new button(document.getElementById("c"), () => play_tones(1633, 852), () => toggle(false));

    let button_star  = new button(document.getElementById("*"), () => play_tones(1209, 941), () => toggle(false));
    let button_zero  = new button(document.getElementById("0"), () => play_tones(1336, 941), () => toggle(false));
    let button_hash  = new button(document.getElementById("#"), () => play_tones(1477, 941), () => toggle(false));
    let button_d     = new button(document.getElementById("d"), () => play_tones(1633, 941), () => toggle(false));

    let busy_tone    = new button(document.getElementById("busy"), () => play_tones(480, 620), () => toggle(false));
    let dial_tone    = new button(document.getElementById("dial"), () => play_tones(350, 440), () => toggle(false));
    let ring_tone    = new button(document.getElementById("ring"), () => play_tones(480, 440), () => toggle(false));
    let error_tone   = new button(document.getElementById("error"), () => play_error(0), () => {});

    document.addEventListener('keyup', function(e) {
        toggle(false);
    });

    document.addEventListener('keydown', function(e) {
        if (e.key in tones) {
            press_button(e.key);
        }
    });


    function draw_sine_wave(canvas, ctx, f1, f2) {
        var h_center  = canvas.height / 2;
        let fscale = Math.abs(f1 - f2) * 4;
        var amplitude = h_center / 3;

        // Fill in background color
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw left to right
        ctx.beginPath();
        ctx.moveTo(0, h_center);

        for (var x=0; x<canvas.width; x++){
    	var y = Math.sin(x * f1 / fscale) * amplitude;
    	ctx.lineTo(x, canvas.height-y - h_center);
        }

        ctx.strokeStyle = "#ff0000";
        ctx.lineWidth = 1;
        ctx.stroke();

        // Draw left to right
        ctx.beginPath();
        ctx.moveTo(0, h_center);

        for (var x=0; x<canvas.width; x++){
    	var y = Math.sin(x * f2 / fscale) * amplitude;
    	ctx.lineTo(x, canvas.height-y - h_center);
        }

        ctx.strokeStyle = "#0000ff";
        ctx.lineWidth = 1;
        ctx.stroke();

        // Draw left to right
        ctx.beginPath();
        ctx.moveTo(0, h_center);

        for (var x=0; x<canvas.width; x++){
    	var y = (Math.sin(x * f1 / fscale) * amplitude) + (Math.sin(x * f2 / fscale) * amplitude);;
    	ctx.lineTo(x, canvas.height-y - h_center);
        }

        ctx.strokeStyle = "#ff00ff";
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    function update_oscilloscope(f1, f2) {
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");

        draw_sine_wave(canvas, ctx, f1, f2);

        document.getElementById("tone1").innerHTML = f1 + " Hz";
        document.getElementById("tone2").innerHTML = f2 + " Hz";
        document.getElementById("beat").innerHTML = Math.abs(f2 - f1) + " Hz";
    }

  </script>
</html>
