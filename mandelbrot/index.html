<!DOCTYPE html>

<html>
  <head>
    <title>Mandelbrot</title>
     <meta charset="utf-8"/>
     <style>
body {
    margin: 0px;
}
canvas {
    margin : 0px;
    position: absolute;
    top: 0px;
    left: 0px;
}
#controls {
    display: block;
    position: fixed;
    top: 0px;
    left: 0px;
    background:#ffffff;
    width:100%;
    outline:1px solid #606060;
    padding: 5px;
}
.note {
    color:#fff;
    font-style: italic;
    float: right;
}
.coord {
    width:75px;
}
#coords {
    font-family: monospace;
}
#coords_div {
    position: fixed;
    bottom: 5px;
    left:5px;
}
#elapsed_div {
    position: fixed;
    bottom: 5px;
    right:5px;
}
.zoom {
    width: 32px;
}
#download {
    float: right;
    margin-right: 12px;
}
     </style>
  </head>
  <body onresize="resize_canvas();" onload="first_run();">

    <canvas id="canvas" width="768px" height="768px"></canvas>

    <div id="controls">
      <button class="zoom" onclick="zoom(false)">-</button>
      <button class="zoom" onclick="zoom(true)">+</button>
      Depth:
      <select onchange="render()" id="depthSelection">
        <option>1</option>
        <option>2</option>
        <option>4</option>
        <option>8</option>
        <option>16</option>
        <option selected>32</option>
        <option>64</option>
        <option>128</option>
        <option>256</option>
        <option>512</option>
        <option>1024</option>
        <option>2048</option>
        <option>4096</option>
      </select>
      Scale:
      <select onchange="render()" id="renderScale">
        <option selected>1</option>
        <option>2</option>
        <option>4</option>
        <option>8</option>
    </select>
    <!--
      Center Coordinates:
      <input onchange="recenterFromUserCoords();" class="coord" id="x_coord"></input>,
    <input onchange="recenterFromUserCoords();" class="coord" id="y_coord"></input>
    -->
    <span id="download"><a href="#" id="download_link" onclick="save_image();" download="mandelbrot.png">Download PNG</a></span>
    </div>

    <div id="coords_div" class="note">
      Mouse Coordinates: <span id="coords">--,--</span>
    </div>

    <div id="elapsed_div" class="note">
      Render Time: <span id="elapsed">--</span>
    </div>

    <script>

var canvas        = document.getElementById("canvas");
var ctx           = canvas.getContext("2d");
var width         = canvas.width;
var height        = canvas.height;

var view_x_center = 0;
var view_y_center = 0;
var view_width    = 4.5;
var view_height   = 4.5;

var depth         = 10;
var mouse_down    = false;
var mouse_moved   = false;
var start_coord   = null;
var x_diff        = 0;
var y_diff        = 0;

var render_preview = false;
var final_render_timer = null;

// Touch listeners
canvas.addEventListener('touchstart', input_start_touch, false);
canvas.addEventListener('touchmove',  input_move_touch, false);
canvas.addEventListener('touchend',   input_end_touch, false);

function getTouchPosition(canvas, event){
    if (!e)
        var e = event;

    var x_coord = null;
    var y_coord = null;

    if(e.touches) {
        if (e.touches.length == 1) { // Only deal with one finger
            let touch = e.touches[0]; // Get the information for finger #1
            let x_pixel = touch.pageX-touch.target.offsetLeft;
            let y_pixel = touch.pageY-touch.target.offsetTop - (tile_height); // Adjust y because apple messes things up!

            // Determine scale
            const x_scale = view_width / width;
            const y_scale = view_height / height;

            // Update label
            var view_left = view_x_center - (view_width / 2);
            var view_top  = view_y_center - (view_height / 2);
            x_coord = x_pixel * x_scale + view_left;
            y_coord = y_pixel * y_scale + view_top;
        }
    }

    return {x:x_coord, y:y_coord};
}

function input_start_touch(e){
    last_touch_position = getTouchPosition(canvas, e)
    mouse_down = true;
    e.preventDefault();
}

function input_move_touch(e){
    if (mouse_down == true){
        mouse_moved = true;
        // Get current coords
        let current_coord = getTouchPosition(canvas, e)

	// Find difference
	x_diff = current_coord.x - start_coord.x;
	y_diff = current_coord.y - start_coord.y;

	render();
    }
    e.preventDefault();
}

function input_end_touch(e){
    input_up_mouse(e);
    e.preventDefault();
}


// Mouse listeners
canvas.addEventListener('mousedown',  input_down_mouse);
canvas.addEventListener('mousemove',  input_move_mouse);
canvas.addEventListener('mouseup',    input_up_mouse);
canvas.addEventListener('wheel',      input_wheel);

function input_down_mouse(e){
    start_coord = getCursorPosition(canvas, e);
    mouse_down = true;
}

function input_move_mouse(e){
    if (mouse_down == true){
	mouse_moved = true;
	render_preview = true
	// Get current coords
	let current_coord = getCursorPosition(canvas, e);

 	// Find difference
	x_diff = current_coord.x - start_coord.x;
	y_diff = current_coord.y - start_coord.y;

	render();
    } else {
	let coords = getCursorPosition(canvas, e);
	let string = ""
	if (coords.x > 0)
	    string += "+"
	string += coords.x.toFixed(5);
	while (string.length < 8)
	    string += "0";
	string += ",";
	if (coords.y < 0)
	    string += "+"
	string += (-1 * coords.y.toFixed(5));
	while (string.length < 17)
	    string += "0";
	document.getElementById("coords").innerHTML = string;
    }
}

function input_up_mouse(e){
    if (mouse_down == true){
	if (mouse_moved == true) {
	    // Recenter using offsets
	    recenter(
		view_x_center - x_diff,
		view_y_center - y_diff
	    );

	} else {
	    // Recenter to mouse position
	    recenter(
		start_coord.x,
		start_coord.y
	    );
	}

	// Reset offsets
	x_diff = 0;
	y_diff = 0;

	// Stop moving
	mouse_down = false;
	mouse_moved = false;
	render_preview = false;

	// Rerender
	render();
    }
}

function input_wheel(e){
    render_preview = true;
    if (e.deltaY > 0)
	zoom(false);
    else
	zoom(true);
}

function render(reset_preview_request = false){
    // Set settings
    depth = Number(document.getElementById("depthSelection").value);
    scale = Number(document.getElementById("renderScale").value);

    // Deal with preview renders
    // Clear existing timeouts (requests for final frames)
    clearTimeout(final_render_timer);

    // If final frame requested, clear the preview flag
    if (reset_preview_request == true){
	render_preview = false;
    }

    // If preview requested...
    if (render_preview == true){
	scale = 8;
	// If there is a render preview request, set a timeout to render actual image after 1/2 second
	if (mouse_down != true){
	    final_render_timer = setTimeout(() => render(true), 500);
	}
    }

    // Start timer
    var start = new Date().getTime();

    // Decide on effective center position
    let effective_x_center = view_x_center - x_diff;
    let effective_y_center = view_y_center - y_diff;

    // Render
    var scaled_x  = view_width / width;
    var scaled_y  = view_height / height;
    var view_left = effective_x_center - (view_width / 2);
    var view_top  = effective_y_center - (view_height / 2);
    
    for (var y=0; y<height; y+=scale){
        for (var x=0; x<width; x+=scale){
            var xValue = (x * scaled_x) + (view_left);
            var yValue = (y * scaled_y) + (view_top);
            var result = mandel(xValue, yValue, depth);
            
            // Choose a color
            var finalColor = "#000000";
            if (result != -1)
                finalColor = chooseColor(result, depth);
            
            // Draw the pixel
            ctx.fillStyle = finalColor;
            ctx.fillRect(x, y, scale, scale);

        }
    }
    
    // End timer
    var duration = (new Date().getTime() - start);
    var minutes = Math.floor(duration/1000/60);
    var seconds = Math.floor(duration/1000) % 60;
    var miliseconds = Math.floor(duration) % 1000;
    if (seconds < 10) { seconds = "0" + seconds; }
    if (minutes < 10) { minutes = "0" + minutes; }
    var duration_string = minutes +":"+ seconds +"."+ miliseconds;
    document.getElementById("elapsed").innerHTML = duration_string;

}

function mandel(x, y, depth){
    // Prime Values
    var xP=0;
    var yP=0;
    // Temporary Values
    var xT=0;
    var yT=0;
    var i=0;

    for (i=0; i<depth; i++)
    {
        xT = (Math.pow(xP, 2)) + x - (Math.pow(yP, 2));
        yT = 2 * xP * yP + y;
        if (Math.pow(Math.abs(xT),2) + Math.pow(Math.abs(yT),2) > 4)
            return i;
        xP = xT;
        yP = yT;
    }
    return -1;
}

function chooseColor(i, d) {
    var r = 0;
    var g = 0;
    var b = 0;

    const band = d / 6;
    
    if (i >= band * 0 & i < band * 1){
        r = 0xff;
        g = 0xff * i / band;
    }
    if (i >= band * 1 & i < band * 2) {
        g = 0xff;
        r = 0xff * ((band - (i % band)) / band);
    }
    if (i >= band * 2 & i < band * 3) {
        g = 0xff;
        b = 0xff * (i % band) / band;
    }
    if (i >= band * 3 & i < band * 4) {
        b = 0xff;
        g = 0xff * ((band - (i % band)) / band);
    }
    if (i >= band * 4 & i < band * 5) {
        b = 0xff;
        r = 0xff * (i % band) / band;
    }
    if (i >= band * 5 & i < band * 6) {
        r = 0xff;
        b = 0xff * ((band - (i % band)) / band);
    }

    return "#"+hexString(r)+hexString(g)+hexString(b);
}

function hexString(n) {
    t = Math.floor(n).toString(16)
    if (t.length % 2) {
        t = "0" + t;
    }
    return t;
}

function recenterFromUserCoords(){
    let x = Number(document.getElementById("x_coord").value);
    let y = Number(document.getElementById("y_coord").value);

    recenter(x, y);
}

function recenter(x, y){
    view_x_center = x;
    view_y_center = y;

    //document.getElementById("x_coord").value = x.toFixed(3);
    //document.getElementById("y_coord").value = y.toFixed(3);

    render();
}

function getCursorPosition(canvas, event){
    // Determine pixel location
    const rect = canvas.getBoundingClientRect()
    const x_pixel = event.clientX - rect.left
    const y_pixel = event.clientY - rect.top

    // Determine scale
    const x_scale = view_width / width;
    const y_scale = view_height / height;

    // Update label
    var view_left = view_x_center - (view_width / 2);
    var view_top  = view_y_center - (view_height / 2);
    var x_coord = x_pixel * x_scale + view_left;
    var y_coord = y_pixel * y_scale + view_top;

    return {x:x_coord, y:y_coord};
}

function zoom(zoom_in){
    if (zoom_in == true){
	view_width /= 2;
	view_height /= 2;
    } else {
	view_width *= 2;
	view_height *= 2;
    }

    render();
}

function resize_canvas(preview = true){
    width  = window.innerWidth;
    height = window.innerHeight;
    canvas.width  = width;
    canvas.height = height;

    // Keep view height the same, but change view width to match aspect ratio
    let t = height / view_height;
    view_width = width / t;

    // Set render_preview to make update faster
    render_preview = preview;

    render();
}

function save_image(){
    document.getElementById("download_link").download = "image.png";
    document.getElementById("download_link").href = canvas.toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
}

function first_run(){
    resize_canvas(false);
}


</script>
  </body>
</html>
