<html class=" bapbjszogs idc0_343"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Test</title>
    <meta name="viewport" content="user-scalable=no">
    <style>

canvas{
    border: 0px solid black;
    touch-action:manipulation;
    position:absolute;
    top:0;
    left:0;
}

label{
    display:inline-block;
    vertical-align: middle;
    width: 70px;
}

input{
    vertical-align: middle;
}

body{
    margin: 0px;
}

#controls{
    position:absolute;
    top: 10px;
    left: 10px;
}
    </style>
  </head>
  <body onload="main();" onresize="resize();">
    <canvas id="canvas" width="1539" height="1004"></canvas>
    <div id="controls">
      <label for="decay">Decay:</label>       <input id="decay"    type="range" min="0" max="100" value="50"  oninput="update_decay();"><br>
      <label for="diameter">Diameter:</label> <input id="diameter" type="range" min="0" max="100" value="50"><br>
      <label for="red">Red:</label>           <input id="red"      type="range" min="0" max="255" value="255" onchange="update_color();"><br>
      <label for="green">Green:</label>       <input id="green"    type="range" min="0" max="255" value="50"  onchange="update_color();"><br>
      <label for="blue">Blue:</label>         <input id="blue"     type="range" min="0" max="255" value="50"  onchange="update_color();"><br>
    <!--
    Coordinates: <span id="coords">-, -</span>
    <br>
    Debug: <span id="debug"></span>
    -->
    </div>
<script>

// Globals!
let canvas = document.querySelector('canvas')
let ctx    = canvas.getContext('2d');
let decay  = .05;
let last_frame;
let pens   = [];
let MAX_FINGERS = 5;
let color  = {r:0xff, g:0x00, b:0x00};

// Touch Listeners
function getTouchPosition(event, finger){
    if (!e)
        var e = event;

    var x = null;
    var y = null;

    if(e.touches[finger]) {
        var touch = e.touches[finger];
        x = touch.pageX-touch.target.offsetLeft;
        y = touch.pageY-touch.target.offsetTop;

        return {x:x, y:y};
    }
    
    return -1;
}

function input_touch_down(e){
    e.preventDefault();
    for (let i=0; i<MAX_FINGERS; i++){
        pens[i].mouse_down = true;
        pens[i].draw_line(getTouchPosition(e, i));
    }
}

function input_touch_move(e){
    e.preventDefault();
    for (let i=0; i<MAX_FINGERS; i++)
        if (pens[i].mouse_down == true)
	    pens[i].draw_line(getTouchPosition(e, i));
}

function input_touch_up(e){
    e.preventDefault();
    for (let i=0; i<MAX_FINGERS; i++){
        pens[i].mouse_down = false;
        pens[i].last_coords = null;
    }
}

canvas.addEventListener('touchstart', input_touch_down, false);
canvas.addEventListener('touchmove',  input_touch_move, false);
canvas.addEventListener('touchend',   input_touch_up,   false);

// Mouse Listeners
function getCursorPosition(canvas, event){
    // Determine where clicked
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    //document.getElementById("coords").innerHTML = x + ", " + y;

    return {x:x, y:y};
}

canvas.addEventListener('mousedown', function(e){
    pens[0].mouse_down = true;
    pens[0].draw_line(getCursorPosition(canvas, e));
});

canvas.addEventListener('mousemove', function(e){
    if (pens[0].mouse_down == true)
	pens[0].draw_line(getCursorPosition(canvas, e));
});

canvas.addEventListener('mouseup', function(e){
    pens[0].mouse_down = false;
    pens[0].last_coords = null;
});

class pen {
    constructor(ctx){
        this.ctx = ctx;
        this.last_coords;
        this.mouse_down = false;
    }

    draw_line(coords){
        if (coords == -1) return;

        if (this.last_coords == undefined)
	    this.last_coords = {x:coords.x, y:coords.y};

        let r = document.getElementById("diameter").value/2;

        let dx = coords.x - this.last_coords.x;
        let dy = coords.y - this.last_coords.y;

        let distance = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));

        for (let i=1; i<distance; i+=1){
	    let p = i / distance;
	    this.draw_gradient(this.last_coords.x + (dx * p), this.last_coords.y + (dy * p));
        }

        this.last_coords = {x:coords.x, y:coords.y};
    }

    draw_gradient(x, y){
        let r = document.getElementById("diameter").value/2;

        let innerRadius = 0;
        let outerRadius = r;

        var gradient = this.ctx.createRadialGradient(x, y, innerRadius, x, y, outerRadius);
        gradient.addColorStop( 0, "rgba("+color.r+","+color.g+","+color.b+", 1)");
        gradient.addColorStop(.5, "rgba("+color.r+","+color.g+","+color.b+",.1)");
        gradient.addColorStop( 1, "rgba("+color.r+","+color.g+","+color.b+", 0)");

        this.ctx.beginPath();
        this.ctx.moveTo(x, y);
        this.ctx.arc(x, y, r, 0, 2*Math.PI);
        this.ctx.fillStyle = gradient;
        this.ctx.fill();
    }

    redraw_gradient(){
        if (this.last_coords != undefined)
            this.draw_gradient(this.last_coords.x, this.last_coords.y);
    }
}

function slowly_fade(timestamp) {
    if (last_frame == undefined) {
        last_frame = timestamp;
    }

    const elapsed = timestamp - last_frame;

    last_frame = timestamp;

    // Test; try increasing value of everysingle pixel
    var img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var pix = img.data;
    for (var i=0; i<pix.length; i+=1){
	pix[i] = pix[i] + 1 > 255 ? 255: pix[i] + (decay * elapsed);
    }

    ctx.putImageData(img, 0, 0);

    for (let i=0; i<pens.length; i++)
        if (pens[i].mouse_down)
            pens[i].redraw_gradient();

    window.requestAnimationFrame(slowly_fade);
}

function resize(){
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
}

function update_decay(){
    let value = document.getElementById("decay").value;
    decay = value / 200;
}

function update_color(){
    color = {
        r: document.getElementById("red").value,
        g: document.getElementById("green").value,
        b: document.getElementById("blue").value,
    };
}

function main(){
    // Create pen instances (support 5 fingers)
    for (let i=0; i<MAX_FINGERS; i++)
        pens.push(new pen(ctx));

    // Resize canvas
    resize();

    // Update variables
    update_decay();
    update_color();

    // Initialize the screen with a white rectangle
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Start fading loop
    slowly_fade();
}

function debug(m){
    document.getElementById("debug").innerHTML = m;
}

</script>

</body></html>
