<html>
  <head>
    <title>Test</title>
    <style>
      body {
          background: #aaa;
          color: #000;
	  font-family: sans-serif;
      }

      div#content {
	  background: #fff;
          width: 768px;
          margin: 0 auto 0 auto;
          padding: 15px;
          border-radius: 20px;
      }

      h1 {
	  margin: 10px;
	  font-size: 3em;
      }

      .hidden {
          display: none;
      }

      button {
          height: 75px;
      }

      button#test, button#stop {
          width: 100%;
      }

      button#left, button#right {
          width: 49.5%;
          margin-bottom: 5px;
      }

      #controldiv {
          text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <h1>Hearing Threshold Test</h1>
      <h2>Instructions</h2>
      <p>Lorem Ipsum</p>
      <h2>Disclaimer</h2>
      <p>Lorum Ipsum</p>

      <div id="startdiv">
        <button onclick="begin_test();" id="test">Begin Test</button>
      </div>

      <div id="controldiv" class="hidden">
        <button onclick="heard(-1);" id="left">Left</button>
        <button onclick="heard(1);" id="right">Right</button>
        <button onclick="stop();" id="stop">Stop Test</button>
      </div>

      <div id="resultsdiv" class="hidden">
        <h2>Results</h2>
        <canvas id="canvas"></canvas>
      </div>
    </div>
  </body>
  <script>

    // Keyboard Listeners
    document.addEventListener('keydown', function(e) {
        //console.log(e)
        switch (e.key) {
        case "ArrowLeft":
            heard_left = true;
            break;;
        case "ArrowRight":
            heard_right = true;
            break;;
        }
    });

    // Audio
    function create_audio_context() {
        audio_ctx = new AudioContext();
        oscillator = audio_ctx.createOscillator();
        gainNode = audio_ctx.createGain();
        stereoNode = new StereoPannerNode(audio_ctx, {pan: 0});

        oscillator.connect(gainNode);
        gainNode.connect(stereoNode);
        stereoNode.connect(audio_ctx.destination);

        gainNode.gain.setValueAtTime(0, audio_ctx.currentTime);

        oscillator.start(0);
    }

    const LEFT = -1;
    const RIGHT = 1;

    let audio_ctx;
    let oscillator;
    let gainNode;
    let stereoNode;

    let timeout;

    let heard_left = false;
    let heard_right = false;

    let tones = [250, 500, 1000, 1500, 2000, 3000, 4000, 8000];
    let results = [];
    let current_test_index;

    function start_tone(f, v) {
        oscillator.type = "sine";
        oscillator.frequency.setValueAtTime(f, audio_ctx.currentTime);
        gainNode.gain.setValueAtTime(v, audio_ctx.currentTime);
        //console.log("should be playing: ", f)
    }

    function stop_tone() {
        gainNode.gain.setValueAtTime(0, audio_ctx.currentTime);
        // Give user some time to respond
        timeout = setTimeout(() => complete_tone_test(), 3000);
    }

    function play_tone(f, v, s, d) {
        stereoNode.pan.value = s;
        start_tone(f, v);
        timeout = setTimeout(() => stop_tone(), d);
    }

    function is_finished() {
        for (let t of results)
            if (t.threshold == -1)
                return false;
        return true;
    }

    function initiate_tone_test() {
        // Pick an ear & tone randomly; verify they are not complete yet
        current_test_index = Math.floor(Math.random() * results.length);
        let ear  = results[current_test_index].side;

        // Only test if a threshold has not been achieved
        if (results[current_test_index].threshold == -1) {

            // Pick the next threshold to test
            let v = .1; // starting volume
            if (results[current_test_index].test.length > 0)
                if (results[current_test_index].test[results[current_test_index].test.length - 1].h == true) {
                    v = results[current_test_index].test[results[current_test_index].test.length - 1].v * .5;
                } else {
                    v = results[current_test_index].test[results[current_test_index].test.length - 1].v * 1.5;
                }

            // Clear out response
            heard_left = false;
            heard_right = false;

            // Prep results
            results[current_test_index].test.push({v:v, h:-1});

            // Play tone
            console.log("Testing " + (ear == LEFT ? "left" : "right") + " ear, " + results[current_test_index].tone + " at " + v*100 + " % volume");
            play_tone(results[current_test_index].tone, v, ear, 1000);

        } else {
            // Try again
            initiate_tone_test();
        }
    }

    function complete_tone_test() {
        let ear  = results[current_test_index].side;
        let r = results[current_test_index].test;
        let v = r[r.length - 1].v;

        // Check for response & mark result
        if (ear == LEFT)
            r[r.length - 1].h = heard_left;
        if (ear == RIGHT)
            r[r.length - 1].h = heard_right;

        // See if we are finished with this ear/tone combination
        // If we can hear all the way here, then let's call it good.
        if (v < .001 && r[r.length - 1].h == true)
            results[current_test_index].threshold = .001;

        // If we heard the last tone, but not this one, then let's call it good.
        if (v.length > 1)
            if (r[r.length - 2].h == true && r[r.length - 1].h == false)
                results[current_test_index].threshold = r[r.length - 2].v;

        // If not finished, do next tone
        if (!is_finished())
            initiate_tone_test();
        else
            test_complete();
    }

    function begin_test() {
        // Setup the audio settings
        setup();

        // reset the results
        results = [];
        for (let s of [LEFT, RIGHT])
            for (let t of tones)
                results.push({
                    tone       : t,
                    side       : s,
                    threshold  : -1,
                    test       : [],
                });

        // Hide the start button and show the controls
        document.getElementById("startdiv").classList.add("hidden");
        document.getElementById("controldiv").classList.remove("hidden");
        document.getElementById("resultsdiv").classList.add("hidden");

        // Start
        initiate_tone_test();
    }

    function test_complete() {
        // Unhide the start button and hide the controls
        document.getElementById("startdiv").classList.remove("hidden");
        document.getElementById("controldiv").classList.add("hidden");
        document.getElementById("resultsdiv").classList.remove("hidden");

        console.log(results);
    }

    function stop() {
        clearTimeout(timeout);

        gainNode.gain.setValueAtTime(0, audio_ctx.currentTime);

        test_complete();
    }

    function debug() {
        play_tone(440, .1, RIGHT, 500)
    }

    function heard(e) {
        if (e == LEFT)
            heard_left = true;
        if (e == RIGHT)
            heard_right = true;
    }

    function setup() {
        create_audio_context();
    }

  </script>
</html>
