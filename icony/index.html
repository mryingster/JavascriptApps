<html>
  <head>
    <title></title>
    <style>
      body {
          background-image: url("https://home.yingster.net/apps/resedit/images/tile.png");
      }

      .window {
          border : 0px solid black;
          position : absolute;
          overflow : clip;
      }

      canvas {
          position : absolute;
      }

      .hidden {
          display: none;
      }

      .editor {
          position: absolute;
          left: 64px;
          top: 30;
          border: 1px solid black;
      }

      .jscolor {
          border: 1px black solid;
          box-shadow: black 2px 2px;
          width: 28px;
          height: 18px;
      }

      #foreground {
          position:absolute;
          margin-top:213px;
          margin-left:13px;
      }

      #background {
          position:absolute;
          margin-top:226px;
          margin-left:25px;
      }

      div#tools {
          border: 0px solid green;
          background-color: #000000;
          width: 43px;
          height: 148px;
          position: absolute;
          margin-top: 30px;
          margin-left: 14px;
          line-height: 0px;
          padding: 0px;
      }

      button.tool {
          width: 21px;
          padding: 0px;
          margin: 0;
          display: inline-block;
          border: 0px solid red;
          height: 21px;
      }

      button#lasso                      { background:url("https://home.yingster.net/apps/resedit/images/tools.png")   0px    0px; }
      button#marquee                    { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -21px    0px; }
      button#eraser                     { background:url("https://home.yingster.net/apps/resedit/images/tools.png")   0px  -21px; }
      button#pencil                     { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -21px  -21px; }
      button#eyedropper                 { background:url("https://home.yingster.net/apps/resedit/images/tools.png")   0px  -42px; }
      button#paint_bucket               { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -21px  -42px; }
      button#nothing                    { background:url("https://home.yingster.net/apps/resedit/images/tools.png")   0px  -63px; }
      button#line                       { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -21px  -63px; }
      button#filled_rect                { background:url("https://home.yingster.net/apps/resedit/images/tools.png")   0px  -84px; }
      button#empty_rect                 { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -21px  -84px; }
      button#filled_round_rect          { background:url("https://home.yingster.net/apps/resedit/images/tools.png")   0px -105px; }
      button#empty_round_rect           { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -21px -105px; }
      button#filled_oval                { background:url("https://home.yingster.net/apps/resedit/images/tools.png")   0px -126px; }
      button#empty_oval                 { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -21px -126px; }
      button#lasso.selected             { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -43px    0px; }
      button#marquee.selected           { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -64px    0px; }
      button#eraser.selected            { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -43px  -21px; }
      button#pencil.selected            { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -64px  -21px; }
      button#eyedropper.selected        { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -43px  -42px; }
      button#paint_bucket.selected      { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -64px  -42px; }
      button#nothing.selected           { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -43px  -63px; }
      button#line.selected              { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -64px  -63px; }
      button#filled_rect.selected       { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -43px  -84px; }
      button#empty_rect.selected        { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -64px  -84px; }
      button#filled_round_rect.selected { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -43px -105px; }
      button#empty_round_rect.selected  { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -64px -105px; }
      button#filled_oval.selected       { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -43px -126px; }
      button#empty_oval.selected        { background:url("https://home.yingster.net/apps/resedit/images/tools.png") -64px -126px; }

    </style>
  </head>
  <body>
    <script src="https://home.yingster.net/apps/resedit/jscolor.js"></script>
    <div id="content">
      <button onclick="new_window(-1);">New Window</button>
      <input class="hidden" type="file" id="load"/>
    </div>
  </body>
  <script>

class toolbox {
    constructor(div, id) {
	this.div = div;
        this.id  = id;
	this.cursors = {
	    pencil     : "url(https://home.yingster.net/apps/resedit/cursors/pencil.png)      0 15, default",
	    crosshair  : "url(https://home.yingster.net/apps/resedit/cursors/crosshair.png)   6  6, crosshair",
	    eraser     : "url(https://home.yingster.net/apps/resedit/cursors/eraser.png)      3  3, default",
	    eyedropper : "url(https://home.yingster.net/apps/resedit/cursors/eyedropper.png)  1 15, default",
	    bucket     : "url(https://home.yingster.net/apps/resedit/cursors/bucket.png)     13 15, default",
	    default    : "default"
	};

	this.tools = {
	    "lasso"             : this.cursors.pencil,
	    "marquee"	        : this.cursors.crosshair,
	    "eraser"	        : this.cursors.eraser,
	    "pencil"	        : this.cursors.pencil,
	    "eyedropper"        : this.cursors.eyedropper,
	    "paint_bucket"      : this.cursors.bucket,
	    "nothing"           : this.cursors.default,
	    "line"              : this.cursors.pencil,
	    "filled_rect"       : this.cursors.crosshair,
	    "empty_rect"        : this.cursors.crosshair,
	    "filled_round_rect" : this.cursors.crosshair,
	    "empty_round_rect"  : this.cursors.crosshair,
	    "filled_oval"       : this.cursors.crosshair,
	    "empty_oval"        : this.cursors.crosshair,
	};

	this.selected = null;

	for (var tool in this.tools) ((tool) => {
	    let button = document.createElement('button');
	    button.classList.add("tool");
            button.classList.add(this.id);
            button.classList.add(tool);
	    button.onclick = function() { this.select(tool) }.bind(this);
	    button.id = tool;
	    this.div.appendChild(button);
	})(tool)
    }

    select(t) {
	for (var button of document.getElementsByClassName("tool")) {
            if (button.classList.contains(this.id)) {
	        button.classList.remove("selected");
	        if(button.classList.contains(t)) {
		    // Select tool
		    button.classList.add("selected");
		    this.selected = t;

		    // Change Cursor
		    if (this.tools[t] != null)
		        for (let a of document.getElementsByClassName("editor"))
                            if (a.classList.contains(this.id))
			        a.style.cursor = this.tools[t];
                }
            }
	}
    }
}

class artboard {
    constructor(canvas, fgcolor, bgcolor, icon_size, tools, default_color, render_window, id){
	// Constants
	this.canvas  = canvas;
	this.tools   = tools;
	this.foreground_color = fgcolor;
	this.background_color = bgcolor;
        this.default_color = default_color;
        this.id = id;
        this.canvas.classList.add(this.id);

        // Functions in other class
        this.render_window = render_window;

	// Artboard settings
	this.icon_size		= icon_size;
	this.square_size	= 7;
	this.border_size	= 1;
	this.width		= this.icon_size * (this.square_size + this.border_size) + this.border_size;
	this.height		= this.icon_size * (this.square_size + this.border_size) + this.border_size;
	this.artboard_ctx	= canvas.getContext("2d");

	// Set canvas size
	this.canvas.width	= this.width;
	this.canvas.height	= this.height;

	this.update_preview     = null;

	// State
	this.state = {
	    "artboard_array"      : this.initialize_2d_array(this.icon_size, this.icon_size, this.default_color),
	    "prev_artboard_array" : this.initialize_2d_array(this.icon_size, this.icon_size, this.default_color),
            "overlay_array"       : this.initialize_2d_array(this.icon_size, this.icon_size, "rgba(0,0,0,0)"),
	    "actual_color"        : null,
	    "mouse_down"          : false,
	    "mouse_down_pos"      : {x:null, y:null},
	};

        this.history = [];

	this.selection = {
	    "selected"            : false,
	    "moved"               : false,
	    "source_artboard"     : null,
            "source_coords"       : { x0:null, y0:null, x1:null, y1:null },
	    "start_coords"        : { x0:null, y0:null, x1:null, y1:null },
	    "last_coords"         : { x0:null, y0:null, x1:null, y1:null },
	    "dest_coords"         : { x0:null, y0:null, x1:null, y1:null },
	    "blink_position"      : 0,
	    "timer"               : null,
            "replace_background"  : false,
	};

	// Listeners
	this.canvas.addEventListener('mousedown', function(e){
	    let pos = this.getCursorPosition(canvas, e)

            // Select this window
            background_other_windows(this.id);

            // Record canvas before editing for undo information
            this.record();

	    // Record our click position, but only if the mouse thinks it isn't already down
	    if (this.state.mouse_down != true)
		this.state.mouse_down_pos = pos;

	    if (this.tools.selected == "marquee")
		this.mouse_down_marquee(pos);

	    this.action(pos);
	    this.state.mouse_down = true;
	}.bind(this))

	this.canvas.addEventListener('mousemove', function(e) {
	    if (this.state.mouse_down == true) {
		let pos = this.getCursorPosition(canvas, e)
		this.action(pos);
	    }
	}.bind(this))

	this.canvas.addEventListener('mouseleave', function(e) {
	    this.state.mouse_down = false;
	    this.state.use_bg_color = false;
	    this.state.prev_artboard_array = JSON.parse(JSON.stringify(this.state.artboard_array));

	    if (this.tools.selected == "marquee")
		this.mouse_up_marquee();
	}.bind(this))

	this.canvas.addEventListener('mouseup', function(e) {
	    this.state.mouse_down = false;
	    this.state.use_bg_color = false;
	    this.state.prev_artboard_array = JSON.parse(JSON.stringify(this.state.artboard_array));

	    if (this.tools.selected == "marquee")
		this.mouse_up_marquee();

            this.render_window();
	}.bind(this))

	this.redraw_canvas();
    }

    replace_artboard_array(a) {
        // Save what we have so we can undo
        this.record();

        // Load new array
        this.state.artboard_array = a;

        // Redraw!
        this.redraw_canvas();
    }

    record() {
        this.history.push(this.initialize_2d_array(this.icon_size, this.icon_size, this.default_color));
        this.history[this.history.length - 1] = JSON.parse(JSON.stringify(this.state.artboard_array));
    }

    initialize_2d_array(x, y, c){
	let new_array = [];
	while (new_array.length < y){
	    let new_row = [];
	    while (new_row.length < x){
		new_row.push(c);
	    }
	    new_array.push(new_row);
	}
	return new_array;
    }

    getCursorPosition(canvas, event){
	// Determine where clicked
	const rect = canvas.getBoundingClientRect()
	const realx = event.clientX - rect.left
	const realy = event.clientY - rect.top

	// Determine square size
	var pixelx = Math.floor(realx/(this.square_size + this.border_size));
	var pixely = Math.floor(realy/(this.square_size + this.border_size));

	return {x:pixelx, y:pixely};
    }

    mouse_down_marquee(pos){
        // Clearout the animation timeout
        this.clear_marquee_timeout();

	// If nothing is yet selected, record the position for start of selection box
	if (this.selection.selected == false){
	    this.selection.source_artboard = JSON.parse(JSON.stringify(this.state.artboard_array));
	    this.selection.dest_coords.x0 = pos.x;
	    this.selection.dest_coords.y0 = pos.y;
	}
	this.selection.moved = false;

	// Check if we clicked out of the selection area
	if (this.selection.selected == true){
	    if (pos.x < this.selection.dest_coords.x0 ||
		pos.x > this.selection.dest_coords.x1 ||
		pos.y < this.selection.dest_coords.y0 ||
		pos.y > this.selection.dest_coords.y1){

                // Deselect
                this.deselect_marquee();

                // Make new selection
		this.selection.dest_coords.x0 = pos.x;
		this.selection.dest_coords.y0 = pos.y;
	    }
	}
    }

    mouse_up_marquee(){
	// Check to make sure smaller coords in x0/y0
	if (this.selection.dest_coords.y0 > this.selection.dest_coords.y1) {
	    let t = this.selection.dest_coords.y1;
	    this.selection.dest_coords.y1 = this.selection.dest_coords.y0;
	    this.selection.dest_coords.y0 = t;
	}
	if (this.selection.dest_coords.x0 > this.selection.dest_coords.x1) {
	    let t = this.selection.dest_coords.x1;
	    this.selection.dest_coords.x1 = this.selection.dest_coords.x0;
	    this.selection.dest_coords.x0 = t;
	}

        // Make initial selection
	if (this.selection.selected == false) {
	    this.selection.selected = true;
            this.selection.source_artboard = JSON.parse(JSON.stringify(this.state.artboard_array));

            // Set the source coordinates
            this.selection.source_coords = {
                x0: this.selection.dest_coords.x0,
                y0: this.selection.dest_coords.y0,
                x1: this.selection.dest_coords.x1,
                y1: this.selection.dest_coords.y1,
            };

            // Set the start coordinates
            this.selection.start_coords = {
                x0: this.selection.dest_coords.x0,
                y0: this.selection.dest_coords.y0,
                x1: this.selection.dest_coords.x1,
                y1: this.selection.dest_coords.y1,
            };

            // And set the last coordinates
            this.selection.last_coords = {
                x0: this.selection.dest_coords.x0,
                y0: this.selection.dest_coords.y0,
                x1: this.selection.dest_coords.x1,
                y1: this.selection.dest_coords.y1,
            };

            this.selection.replace_background = true;
        }

	// See if the selection area has moved at all
	if (this.selection.moved == true) {
            // Set the last coordinates for our next move
            this.selection.last_coords = {
                x0: this.selection.dest_coords.x0,
                y0: this.selection.dest_coords.y0,
                x1: this.selection.dest_coords.x1,
                y1: this.selection.dest_coords.y1,
            };
        }

	// Check if selection contains nothing, deselect
	if (this.selection.dest_coords.y0 == this.selection.dest_coords.y1 ||
	    this.selection.dest_coords.x0 == this.selection.dest_coords.x1) {
            this.deselect_marquee();
	}

	// Animate if something is still selected
	if (this.selection.selected == true && this.selection.timer == null)
	    this.animate_marquee();
    }

    deselect_marquee() {
        // Stop drawing outline
        this.selection.selected = false;
        this.clear_marquee_timeout();

        // Commit source artboard to actual artboard
        // Draw empty space where came from
        if (this.selection.replace_background) {
	    for(let x=this.selection.start_coords.x0; x<=this.selection.start_coords.x1; x++){
		for(let y=this.selection.start_coords.y0; y<=this.selection.start_coords.y1; y++){
		    this.state.artboard_array[y][x] = this.bg_color();
		}
	    }
        }

        // Draw source image into overlay
        let size_x = this.selection.source_coords.x1 - this.selection.source_coords.x0;
        let size_y = this.selection.source_coords.y1 - this.selection.source_coords.y0;

        for (let y=0; y<=size_y; y++) {
            for (let x=0; x<=size_x; x++) {
                if (this.selection.dest_coords.y0 + y < 0) continue;
                if (this.selection.dest_coords.x0 + x < 0) continue;
                if (this.selection.dest_coords.y0 + y > this.state.artboard_array.length -1) continue;
                if (this.selection.dest_coords.x0 + x > this.state.artboard_array[0].length -1) continue;
		this.state.artboard_array[this.selection.dest_coords.y0 + y][this.selection.dest_coords.x0 + x] = this.selection.source_artboard[this.selection.source_coords.y0 + y][this.selection.source_coords.x0 + x];
            }
        }

        // Clear overlay
        this.state.overlay_array = this.initialize_2d_array(this.icon_size, this.icon_size, "rgba(0,0,0,0)");

        // Reset variables
        this.selection.replace_background = false;

        // Redraw
	this.redraw_overlay();
	this.redraw_canvas();
    }

    animate_marquee(){
        // If no selection, stop animating
        if (! this.selection.selected) return;

	// Clear the overlay
        this.state.overlay_array = this.initialize_2d_array(this.icon_size, this.icon_size, "rgba(0,0,0,0)");

        // Draw empty space where came from
        if (this.selection.replace_background) {
	    for(let x=this.selection.start_coords.x0; x<=this.selection.start_coords.x1; x++){
		for(let y=this.selection.start_coords.y0; y<=this.selection.start_coords.y1; y++){
		    this.state.overlay_array[y][x] = this.bg_color();
		}
	    }
        }

        // Draw source image into overlay
        let size_x = this.selection.source_coords.x1 - this.selection.source_coords.x0;
        let size_y = this.selection.source_coords.y1 - this.selection.source_coords.y0;

        for (let y=0; y<=size_y; y++) {
            for (let x=0; x<=size_x; x++) {
                if (this.selection.dest_coords.y0 + y < 0) continue;
                if (this.selection.dest_coords.x0 + x < 0) continue;
                if (this.selection.dest_coords.y0 + y > this.state.artboard_array.length -1) continue;
                if (this.selection.dest_coords.x0 + x > this.state.artboard_array[0].length -1) continue;
		this.state.overlay_array[this.selection.dest_coords.y0 + y][this.selection.dest_coords.x0 + x] = this.selection.source_artboard[this.selection.source_coords.y0 + y][this.selection.source_coords.x0 + x];
            }
        }

        // Shring outline if we are off the screen on any side
        let selection_bounds_y0 = Math.max(this.selection.dest_coords.y0, 0);
	let selection_bounds_y1 = Math.min(this.selection.dest_coords.y1, this.state.artboard_array.length -1);
	let selection_bounds_x0 = Math.max(this.selection.dest_coords.x0, 0);
	let selection_bounds_x1 = Math.min(this.selection.dest_coords.x1, this.state.artboard_array.length -1);

	// Draw blinking outline
	let position1 = this.selection.blink_position % 6;
	let position2 = this.selection.blink_position % 6;
	let position3 = this.selection.blink_position % 6;
	let position4 = this.selection.blink_position++ % 6;

	for(let x=Math.min(selection_bounds_x0, selection_bounds_x1); x<=Math.max(selection_bounds_x0, selection_bounds_x1); x++)
	    if (position1++ % 6 < 3) {
		this.state.overlay_array[selection_bounds_y0][x] = "#000000";
            } else {
            	this.state.overlay_array[selection_bounds_y0][x] = "#FFFFFF";
            }
	for(let x=Math.max(selection_bounds_x0, selection_bounds_x1); x>=Math.min(selection_bounds_x0, selection_bounds_x1); x--)
	    if (position2++ % 6 < 3) {
		this.state.overlay_array[selection_bounds_y1][x] = "#000000";
            } else {
            	this.state.overlay_array[selection_bounds_y1][x] = "#FFFFFF";
            }
	for(let y=Math.min(selection_bounds_y0, selection_bounds_y1); y<=Math.max(selection_bounds_y0, selection_bounds_y1); y++)
	    if (position3++ % 6 < 3) {
		this.state.overlay_array[y][selection_bounds_x1] = "#000000";
            } else {
            	this.state.overlay_array[y][selection_bounds_x1] = "#FFFFFF";
            }
	for(let y=Math.max(selection_bounds_y0, selection_bounds_y1); y>=Math.min(selection_bounds_y0, selection_bounds_y1); y--)
	    if (position4++ % 6 < 3) {
		this.state.overlay_array[y][selection_bounds_x0] = "#000000";
            } else {
            	this.state.overlay_array[y][selection_bounds_x0] = "#FFFFFF";
            }

	this.redraw_canvas();
        this.redraw_overlay();
	this.selection.timer = setTimeout(() => this.animate_marquee(), 250);
    }

    clear_marquee_timeout() {
        clearTimeout(this.selection.timer);
        this.selection.timer = null;
    }

    recurse(x, y, cc, nc){
	if (cc == nc) return;
	if (this.state.artboard_array[y][x].toLowerCase() != cc.toLowerCase()) return;
	this.state.artboard_array[y][x] = nc;
	if (x+1 < this.icon_size)
	    this.recurse(x+1, y, cc, nc);
	if (x-1 >= 0)
	    this.recurse(x-1, y, cc, nc);
	if (y+1 < this.icon_size)
	    this.recurse(x, y+1, cc, nc);
	if (y-1 >= 0)
	    this.recurse(x, y-1, cc, nc);
    }

    fg_color(){
	return this.foreground_color.jscolor.toHEXString();
    }

    bg_color(){
	return this.background_color.jscolor.toHEXString();
    }

    plot_line_low(x0, y0, x1, y1){
    	let dx = x1 - x0;
	let dy = y1 - y0;
	let yi = 1;
	if (dy < 0) {
	    yi = -1;
	    dy *= -1;
	}
	let D  = (2.0 * dy) - dx;
	let y  = y0;

	for (let x=x0; x<=x1; x++) {
	    this.state.artboard_array[y][x] = this.fg_color();

	    if (D > 0) {
		y += yi;
		D = D + (2 * (dy-dx));
	    } else {
		D = D + (2 * dy);
	    }
	}

	return;
    }

    plot_line_high(x0, y0, x1, y1){
    	let dx = x1 - x0;
	let dy = y1 - y0;
	let xi = 1;
	if (dx < 0) {
	    xi = -1;
	    dx *= -1;
	}
	let D  = (2.0 * dx) - dy;
	let x  = x0;

	for (let y=y0; y<=y1; y++) {
	    this.state.artboard_array[y][x] = this.fg_color();

	    if (D > 0) {
		x += xi;
		D = D + (2 * (dx-dy));
	    } else {
		D = D + (2 * dx);
	    }
	}

	return;
    }

    plot_ellipse(rx, ry, xc, yc){
	let x = 0.0;
	if (rx % 1 != 0) x+=.5; // Workaround for not working on 1/2 radius lengths?
	let y = ry * 1.0;

	// Initial decision parameter of region 1
	let d1 = (ry * ry) - (rx * rx * ry) + (0.25 * rx * rx);
	let dx = 2.0 * ry * ry * x;
	let dy = 2.0 * rx * rx * y;

	// For region 1
	while (dx < dy) {

	    // Color perimeter with 4 way symmetry
	    this.state.artboard_array[y+yc][x+xc] = this.fg_color();
	    this.state.artboard_array[y+yc][-x+xc] = this.fg_color();
	    this.state.artboard_array[-y+yc][x+xc] = this.fg_color();
	    this.state.artboard_array[-y+yc][-x+xc] = this.fg_color();

	    // Checking and updating value of
	    // decision parameter based on algorithm
	    if (d1 < 0) {
		x++;
		dx = dx + (2 * ry * ry);
		d1 = d1 + dx + (ry * ry);
	    } else {
		x++;
		y--;
		dx = dx + (2 * ry * ry);
		dy = dy - (2 * rx * rx);
		d1 = d1 + dx - dy + (ry * ry);
	    }
	}

	// Decision parameter of region 2
	let d2 = ((ry * ry) * ((x + 0.5) * (x + 0.5))) +
	    ((rx * rx) * ((y - 1) * (y - 1))) -
	    (rx * rx * ry * ry);

	// Plotting points of region 2
	while (y >= 0) {

	    // Color perimeter with 4 way symmetry
	    this.state.artboard_array[y+yc][x+xc] = this.fg_color();
	    this.state.artboard_array[y+yc][-x+xc] = this.fg_color();
	    this.state.artboard_array[-y+yc][x+xc] = this.fg_color();
	    this.state.artboard_array[-y+yc][-x+xc] = this.fg_color();

	    // Checking and updating parameter
	    // value based on algorithm
	    if (d2 > 0) {
		y--;
		dy = dy - (2 * rx * rx);
		d2 = d2 + (rx * rx) - dy;
	    } else {
		y--;
		x++;
		dx = dx + (2 * ry * ry);
		dy = dy - (2 * rx * rx);
		d2 = d2 + dx - dy + (rx * rx);
	    }
	}
    }

    action(pos){
	// Make sure pos isn't out of bounds
	if (pos.x >= this.icon_size || pos.y >= this.icon_size) return;

	// Pencil Action
	if (this.tools.selected == "pencil"){
	    // If you just clicked, check if you are actually going to draw white
	    if (this.state.mouse_down == false)
		if (this.state.artboard_array[pos.y][pos.x] == this.fg_color())
		    this.state.use_bg_color = true;

	    if (this.state.use_bg_color == true)
		this.state.artboard_array[pos.y][pos.x] = this.bg_color();
	    else
		this.state.artboard_array[pos.y][pos.x] = this.fg_color();
	}

	// Eraser Action
	if (this.tools.selected == "eraser"){
	    this.state.artboard_array[pos.y][pos.x] = "#ffffff";
	    if (pos.y+1 < this.state.artboard_array.length)
		this.state.artboard_array[pos.y+1][pos.x] = "#ffffff";
	    if (pos.x+1 < this.state.artboard_array[0].length)
		this.state.artboard_array[pos.y][pos.x+1] = "#ffffff";
	    if (pos.y+1 < this.state.artboard_array.length && pos.x+1 < this.state.artboard_array[0].length)
		this.state.artboard_array[pos.y+1][pos.x+1] = "#ffffff";
	}

	// Paint Bucket Action
	if (this.tools.selected == "paint_bucket"){
	    let current_color = this.state.artboard_array[pos.y][pos.x];
	    this.recurse(pos.x, pos.y, current_color, this.fg_color());
	}

	// Nothing Button
	if (this.tools.selected == "nothing"){
	}

	// Eyedropper tool
	if (this.tools.selected == "eyedropper"){
	    this.foreground_color.jscolor.fromString(this.state.artboard_array[pos.y][pos.x]);
	}

	// Filled Rectangle Action
	if (this.tools.selected == "filled_rect"){
	    // Undo the previously drawn box
	    this.revert();

	    for(let x=Math.min(this.state.mouse_down_pos.x, pos.x); x<=Math.max(this.state.mouse_down_pos.x, pos.x); x++){
		for(let y=Math.min(this.state.mouse_down_pos.y, pos.y); y<=Math.max(this.state.mouse_down_pos.y, pos.y); y++){
		    this.state.artboard_array[y][x] = this.fg_color();
		}
	    }
	}

	// Empty Rectangle Action
	if (this.tools.selected == "empty_rect"){
	    // Undo the previously drawn box
	    this.revert();

	    for(let x=Math.min(this.state.mouse_down_pos.x, pos.x); x<=Math.max(this.state.mouse_down_pos.x, pos.x); x++){
		this.state.artboard_array[pos.y][x] = this.fg_color();
		this.state.artboard_array[this.state.mouse_down_pos.y][x] = this.fg_color();
	    }
	    for(let y=Math.min(this.state.mouse_down_pos.y, pos.y); y<=Math.max(this.state.mouse_down_pos.y, pos.y); y++){
		this.state.artboard_array[y][pos.x] = this.fg_color();
		this.state.artboard_array[y][this.state.mouse_down_pos.x] = this.fg_color();
	    }
	}

	// Marquee Action
	if (this.tools.selected == "marquee"){
	    // Clear the overlay
            this.state.overlay_array = this.initialize_2d_array(this.icon_size, this.icon_size, "rgba(0,0,0,0)");

	    // If we have no selection, draw selection box
	    if (this.selection.selected == false) {
		for(let x=Math.min(this.state.mouse_down_pos.x, pos.x); x<=Math.max(this.state.mouse_down_pos.x, pos.x); x++){
		    this.state.overlay_array[pos.y][x] = "#000000";
		    this.state.overlay_array[this.state.mouse_down_pos.y][x] = "#000000";
		}
		for(let y=Math.min(this.state.mouse_down_pos.y, pos.y); y<=Math.max(this.state.mouse_down_pos.y, pos.y); y++){
		    this.state.overlay_array[y][pos.x] = "#000000";
		    this.state.overlay_array[y][this.state.mouse_down_pos.x] = "#000000";
		}

		this.selection.dest_coords.x1 = pos.x;
		this.selection.dest_coords.y1 = pos.y;
            }

            // If we have a selection...
            if (this.selection.selected) {
		// See if click is not previously selected area. Draw a new box...

		// Fill the original selection area with background color
                if (this.selection.replace_background) {
		    for(let x=this.selection.source_coords.x0; x<=this.selection.source_coords.x1; x++){
		        for(let y=this.selection.source_coords.y0; y<=this.selection.source_coords.y1; y++){
			    this.state.overlay_array[y][x] = this.bg_color();
		        }
		    }
                }

		// get the x and y offsets from the move
		let dx = this.state.mouse_down_pos.x - pos.x;
		let dy = this.state.mouse_down_pos.y - pos.y;

                // Record new destination coords
		this.selection.dest_coords.x0 = this.selection.last_coords.x0 - dx;
		this.selection.dest_coords.x1 = this.selection.last_coords.x1 - dx;
		this.selection.dest_coords.y0 = this.selection.last_coords.y0 - dy;
		this.selection.dest_coords.y1 = this.selection.last_coords.y1 - dy;

		// Draw the selected area in the new location
                let selection_width  = this.selection.source_coords.x1 - this.selection.source_coords.x0;
                let selection_height = this.selection.source_coords.y1 - this.selection.source_coords.y0;

		for(let y=0; y<=selection_height; y++) {
		    for(let x=0; x<=selection_width; x++) {
			if (this.selection.dest_coords.y0 + y < 0 || this.selection.dest_coords.y0 + y > this.state.artboard_array.length-1) continue;
			if (this.selection.dest_coords.x0 + x < 0 || this.selection.dest_coords.x0 + x > this.state.artboard_array[0].length-1) continue;
			this.state.overlay_array[this.selection.dest_coords.y0 + y][this.selection.dest_coords.x0 + x] = this.selection.source_artboard[this.selection.source_coords.y0 + y][this.selection.source_coords.x0 + x];
		    }
		}

		// Indicate that we've moved and record the new coords
		this.selection.moved = true;
	    }
	} else if (this.selection.selected) {
            this.deselect_marquee();
        }

	// Filled Rounded Rectangle Action
	if (this.tools.selected == "filled_round_rect"){
	    // Undo the previously drawn box
	    this.revert();

	    for(let x=Math.min(this.state.mouse_down_pos.x, pos.x); x<=Math.max(this.state.mouse_down_pos.x, pos.x); x++){
		for(let y=Math.min(this.state.mouse_down_pos.y, pos.y); y<=Math.max(this.state.mouse_down_pos.y, pos.y); y++){
		    // Skip corner cases
		    if (
			// Vertical corners
			x == pos.x && ( y >= pos.y-2 && y <= pos.y+2 ) ||
			x == pos.x && ( y >= this.state.mouse_down_pos.y-2 && y <= this.state.mouse_down_pos.y+2 ) ||
			x == this.state.mouse_down_pos.x && ( y >= pos.y-2 && y <= pos.y+2 ) ||
			x == this.state.mouse_down_pos.x && ( y >= this.state.mouse_down_pos.y-2 && y <= this.state.mouse_down_pos.y+2 ) ||

			// Horizontal corners
			y == pos.y && ( x >= pos.x-2 && x <= pos.x+2 ) ||
			y == pos.y && ( x >= this.state.mouse_down_pos.x-2 && x <= this.state.mouse_down_pos.x+2 ) ||
			y == this.state.mouse_down_pos.y && ( x >= pos.x-2 && x <= pos.x+2 ) ||
			y == this.state.mouse_down_pos.y && ( x >= this.state.mouse_down_pos.x-2 && x <= this.state.mouse_down_pos.x+2 )
		    ) continue;
		    this.state.artboard_array[y][x] = this.fg_color();
		}
	    }
	}

	// Empty Rounded Rectangle Action
	if (this.tools.selected == "empty_round_rect"){
	    // Undo the previously drawn box
	    this.revert();

	    for(let x=Math.min(this.state.mouse_down_pos.x, pos.x); x<=Math.max(this.state.mouse_down_pos.x, pos.x); x++){
		if ( (x >= pos.x-2 && x <= pos.x+2) || (x >= this.state.mouse_down_pos.x-2 && x <= this.state.mouse_down_pos.x+2) ){
		    if ( x != pos.x && x != this.state.mouse_down_pos.x ){
			if (pos.y < this.state.mouse_down_pos.y){
			    this.state.artboard_array[pos.y+1][x] = this.fg_color();
			    this.state.artboard_array[this.state.mouse_down_pos.y-1][x] = this.fg_color();
			} else {
			    this.state.artboard_array[pos.y-1][x] = this.fg_color();
			    this.state.artboard_array[this.state.mouse_down_pos.y+1][x] = this.fg_color();
			}
		    }
		} else {
		    this.state.artboard_array[pos.y][x] = this.fg_color();
		    this.state.artboard_array[this.state.mouse_down_pos.y][x] = this.fg_color();
		}
	    }

	    for(let y=Math.min(this.state.mouse_down_pos.y, pos.y); y<=Math.max(this.state.mouse_down_pos.y, pos.y); y++){
		if ( (y >= pos.y-2 && y <= pos.y+2) || (y >= this.state.mouse_down_pos.y-2 && y <= this.state.mouse_down_pos.y+2) ){
		    if ( y != pos.y && y != this.state.mouse_down_pos.y ){
			if (pos.x < this.state.mouse_down_pos.x){
			    this.state.artboard_array[y][pos.x+1] = this.fg_color();
			    this.state.artboard_array[y][this.state.mouse_down_pos.x-1] = this.fg_color();
			} else {
			    this.state.artboard_array[y][pos.x-1] = this.fg_color();
			    this.state.artboard_array[y][this.state.mouse_down_pos.x+1] = this.fg_color();
			}
		    }
		} else {
		    this.state.artboard_array[y][pos.x] = this.fg_color();
		    this.state.artboard_array[y][this.state.mouse_down_pos.x] = this.fg_color();
		}
	    }
	}

	// Line Action
	if (this.tools.selected == "line"){
	    // Undo the previously drawn line
	    this.revert();

	    let x0 = this.state.mouse_down_pos.x;
	    let x1 = pos.x;
	    let y0 = this.state.mouse_down_pos.y;
	    let y1 = pos.y;

	    if (Math.abs(y1 - y0) < Math.abs(x1 - x0)) {
		if (x0 > x1)
		    this.plot_line_low(x1, y1, x0, y0)
		else
		    this.plot_line_low(x0, y0, x1, y1)
	    } else {
		if (y0 > y1)
		    this.plot_line_high(x1, y1, x0, y0)
		else
		    this.plot_line_high(x0, y0, x1, y1)
	    }
	}

	// Empty Oval Action
	if (this.tools.selected == "empty_oval" || this.tools.selected == "filled_oval"){
	    // Undo the previously drawn line
	    this.revert();

	    let radius_x = Math.abs(this.state.mouse_down_pos.x - pos.x) / 2;
	    let radius_y = Math.abs(this.state.mouse_down_pos.y - pos.y) / 2;
	    let center_x = Math.min(this.state.mouse_down_pos.x, pos.x) + radius_x;
	    let center_y = Math.min(this.state.mouse_down_pos.y, pos.y) + radius_y;

	    this.plot_ellipse(radius_x, radius_y, center_x, center_y);

	    if (this.tools.selected == "filled_oval")
		for (let rx = 0; rx<radius_x; rx+=1)
		    this.plot_ellipse(rx + (radius_x % 1), radius_y, center_x, center_y);
	}
	this.redraw_canvas();
        this.redraw_overlay();
    }

    undo(){
        if (this.history.length > 0) {
            this.state.artboard_array = JSON.parse(JSON.stringify(this.history[this.history.length - 1]));
            this.redraw_canvas();
            this.render_window();
            this.history.pop();
        }
    }

    revert(){
	this.state.artboard_array = JSON.parse(JSON.stringify(this.state.prev_artboard_array));
	this.redraw_canvas();
    }

    redraw_overlay() {
	for (let y=0; y<this.state.overlay_array.length; y++)
	    for (let x=0; x<this.state.overlay_array[y].length; x++)
		this.draw_pixel({x:x, y:y}, this.state.overlay_array[y][x]);
    }

    redraw_canvas() {
	for (let y=0; y<this.state.artboard_array.length; y++)
	    for (let x=0; x<this.state.artboard_array[y].length; x++)
		this.draw_pixel({x:x, y:y}, this.state.artboard_array[y][x]);

	if (this.update_preview != null)
	    this.update_preview();
    }

    draw_pixel(pos, color){
	let pixel_left = pos.x * (this.square_size + this.border_size) + this.border_size;
	let pixel_top  = pos.y * (this.square_size + this.border_size) + this.border_size;

	// Draw on the artboard
	this.artboard_ctx.fillStyle = color;
	this.artboard_ctx.fillRect(pixel_left, pixel_top, this.square_size, this.square_size);
    }
}

class icon_window {
    constructor(div, id) {
        this.id = id;

        // Load images needed
        this.background = new Image();
        this.background.onload = function() { /*super.render();*/ }
        this.background.src="https://home.yingster.net/apps/resedit/images/background.png";
        this.background_inactive = new Image();
        this.background_inactive.src="https://home.yingster.net/apps/resedit/images/background_inactive.png";

        // Set up div
        this.div = div
        this.div.style.width  = 496;
	this.div.style.height = 304;

        this.div.style.top = 100;
        this.div.style.left = 100;

        this.div.style.zIndex = zindex++;

        // Setup This Window Canvas
        this.canvas = document.createElement('canvas');
        this.canvas.tabIndex = 1;
        this.div.appendChild(this.canvas);

        this.ctx = this.canvas.getContext("2d");

        this.canvas.width  = 496;
	this.canvas.height = 304;

        // Create JS Color Instances
        this.palette_background = document.createElement("button");
        this.palette_background.id = "background";
        this.palette_background.classList.add("jscolor", "{value:'#ffffff',position:'bottom',paletteCols:13,hideOnPaletteClick:true}");
        this.div.appendChild(this.palette_background);
        this.palette_foreground = document.createElement("button");
        this.palette_foreground.id = "foreground";
        this.palette_foreground.classList.add("jscolor", "{value:'#000000',position:'bottom',paletteCols:13,hideOnPaletteClick:true}");
        this.div.appendChild(this.palette_foreground);
        //this.update_palette();

        // Create toolbox
        this.toolsdiv = document.createElement("div");
        this.toolsdiv.id = "tools";
        this.tools = new toolbox( this.toolsdiv, this.id );
        this.div.appendChild(this.toolsdiv);

        // Set up editor canvases
        this.icon32_canvas = document.createElement('canvas');
        this.icon32_canvas.classList.add("editor");
        this.icon32_canvas.tabIndex = 1;
        this.div.appendChild(this.icon32_canvas);
        this.icon32 = new artboard(
            this.icon32_canvas,
            this.palette_foreground,
            this.palette_background,
            32,
            this.tools,
            "#FFFFFF",
            () => this.render(),
            this.id
        )

        this.mask32_canvas = document.createElement('canvas');
        this.mask32_canvas.classList.add("editor");
        this.mask32_canvas.tabIndex = 1;
        this.div.appendChild(this.mask32_canvas);
        this.mask32 = new artboard(
            this.mask32_canvas,
            this.palette_foreground,
            this.palette_background,
            32,
            this.tools,
            "#000000",
            () => this.render(),
            this.id
        )

        // State information
        this.mouse_down  = false;
        this.mouse_start = null;
        this.command_down = false;

        this.window_pos     = { x: 100, y: 100 };
        this.window_new_pos = { x: 100, y: 100 };
        this.window_move    = false;
        this.minimized      = false;
        this.inactive       = false;
        this.selected       = "icon32";
        this.deleted        = false;

        this.icon_drag       = false;
        this.icon_drag_start = null;

        // Editor Information
        this.editor_square_size = 7;
        this.editor_border_size = 1;
        this.editor_pos         = { x:67, y:32, w:256, h:256 };

        // Listeners
	this.canvas.addEventListener('mousedown', function(e){
	    let pos = this.get_canvas_cursor_position(this.canvas, e)

            // Set focus on this canvas, and send other to back
            background_other_windows(this.id);

            // If the pos is < 30, this is title bar interaction
            if (pos.y < 30) {
                if (this.click_in_rect(4, 4, 16, 16, pos)) {
                    this.close();
                } else if (this.click_in_rect(479, 4, 490, 16, pos)) {
                    this.minimize();
                } else {
                    let page_pos = this.get_page_cursor_position(e);
                    this.window_move = page_pos;
                }
            }

            // If the position is in the editor area, draw
            if (this.click_in_rect(67, 32, 324, 289, pos)) {
                let editor_cursor_pos = this.get_editor_cursor_position(this.canvas, e);

	        if (this.tools.selected == "marquee")
		    this.mouse_down_marquee(editor_cursor_pos);
	        clearTimeout(this.selection.timer);
                this.selection.timer = null;

	        this.action(editor_cursor_pos);
            }

            // If the position is in the small icon area, allow to drag to mask
            if (this.click_in_rect(334, 31, 366, 63, pos)) {
                this.icon_drag = pos;
                this.icon_drag_start = pos;
            }

	    // Record our click position, but only if the mouse thinks it isn't already down
	    if (this.mouse_down != true)
		this.mouse_start = pos;

	    this.mouse_down = true;
	}.bind(this))

	this.canvas.addEventListener('mousemove', function(e) {
	    if (this.mouse_down != true) {
                return;
	    }

	    let pos = this.get_canvas_cursor_position(this.canvas, e)

            // If the position is in the editor area, draw
            if (this.click_in_rect(67, 32, 324, 289, pos)) {
                let editor_cursor_pos = this.get_editor_cursor_position(this.canvas, e);
	        this.action(editor_cursor_pos);
            }

            // Moving Window
            if (this.window_move != false) {
                this.move_window(this.get_page_cursor_position(e));
            }

            // Dragging Small Icons
            if (this.icon_drag != false) {
                this.icon_drag = pos;
                this.render();
            }

	}.bind(this))

	this.canvas.addEventListener('mouseup', function(e) {
            // Lock in window position if window was moving
            if (this.move_window != false) {
                this.window_pos = {
                    x: this.window_new_pos.x,
                    y: this.window_new_pos.y,
                }
            }

            // Dragging icon to mask
            if (this.icon_drag != false)
                if (this.click_in_rect(334, 91, 366, 123, this.icon_drag))
                    this.update_mask();

            // Selecting editing targets
            if (this.click_in_rect(334, 31, 366, 63, this.icon_drag)) {
                this.selected = "icon32"
                this.select_artboard();
            }
            if (this.icon_drag == false) {
                let pos = this.get_canvas_cursor_position(this.canvas, e)
                if (this.click_in_rect(334, 91, 366, 123, pos)) {
                    this.selected = "mask32"
                    this.select_artboard();
                }
            }

            // Reset states
	    this.mouse_down = false;
            this.window_move = false;
            this.icon_drag = false;
            this.icon_drag_start = false;

            // Reset
            this.render();
	}.bind(this))

	this.canvas.addEventListener('mouseleave', function(e) {
	    this.mouse_down = false;
	}.bind(this))

        this.select_artboard();
        this.render();
    }

    get_page_cursor_position(event) {
	return {x:event.clientX, y:event.clientY};
    }

    get_canvas_cursor_position(canvas, event) {
	// Determine where clicked
	const rect  = canvas.getBoundingClientRect()
	const realx = event.clientX - rect.left;
	const realy = event.clientY - rect.top;

	return {x:realx, y:realy};
    }

    get_editor_cursor_position(canvas, event) {
        // Determine where clicked
	const rect = canvas.getBoundingClientRect()
	const realx = event.clientX - rect.left - this.editor_pos.x;
	const realy = event.clientY - rect.top  - this.editor_pos.y;

	// Determine square size
	var pixelx = Math.floor(realx/(this.editor_square_size + this.editor_border_size));
	var pixely = Math.floor(realy/(this.editor_square_size + this.editor_border_size));

	return {x:pixelx, y:pixely};
    }

    click_in_rect(x1, y1, x2, y2, p) {
        if (p.x < x1 || p.x > x2)
            return false;
        if (p.y < y1 || p.y > y2)
            return false;
        return true;
    }

    undo() {
        if (this.selected == "icon32")
            this.icon32.undo();
        if (this.selected == "mask32")
            this.mask32.undo();
    }

    export(){
        let export_canvas = document.createElement("canvas");
        let export_ctx = export_canvas.getContext("2d");
        export_canvas.width = 32;
        export_canvas.height = 32;

        this.render_icon32_preview(export_ctx, 0, 0, 1, 0);

	window.open(export_canvas.toDataURL('image/png'));

        export_canvas.remove();
    }

    move_window(p) {
        let new_x = this.window_pos.x;
        let new_y = this.window_pos.y;

        if (this.window_move != false) {
            new_x -= this.window_move.x - p.x;
            new_y -= this.window_move.y - p.y;
        }

        if (new_x < 0) new_x = 0;
        if (new_y < 0) new_y = 0;

        this.window_new_pos = {
            x: new_x,
            y: new_y
        };

        this.div.style.top  = new_y;
        this.div.style.left = new_x;
    }

    close() {
        this.deleted = true
        this.save_to_local_storage();
        remove(this.id);
    }

    minimize() {
        if (this.minimized) {
            this.canvas.height = 304;
            this.div.style.height = 304;
            this.minimized = false;
        } else {
            this.canvas.height = 23;
            this.div.style.height = 23;
            this.minimized = true;
        }

        this.render();
    }

    initialize_2d_array(x, y, c){
	let new_array = [];
	while (new_array.length < y){
	    let new_row = [];
	    while (new_row.length < x){
		new_row.push(c);
	    }
	    new_array.push(new_row);
	}
	return new_array;
    }

    replace_mask32_array(a) {
        // Load new array
        this.mask32.replace_artboard_array(a);

        // Redraw!
        this.render();
    }

    replace_icon32_array(a) {
        // Load new array
        this.icon32.replace_artboard_array(a);

        // Redraw!
        this.render();
    }

    get_active_array() {
        let temp_icon = this.icon32;
        if (this.selected == "mask32")
            temp_icon = this.mask32;

        // If a selection marquee is up, only get within those coords
        let coords = { x0: 0, y0: 0, x1:31 , y1:31 };
        if (temp_icon.selection.selected)
            coords = temp_icon.selection.dest_coords;

        let temp_array = temp_icon.state.artboard_array.slice();
        let output_array = [];

        for (let y=coords.y0; y<=coords.y1; y++) {
            let row = []
            for (let x=coords.x0; x<=coords.x1; x++) {
                row.push(temp_array[y][x]);
            }
            output_array.push(row);
        }

        return output_array;
    }

    paste(cb) {
        let temp_icon = this.icon32;
        if (this.selected == "mask32")
            temp_icon = this.mask32;

        // Place clipboard into top left area of canvas
        for (let y=0; y<cb.length; y++)
            for (let x=0; x<cb[0].length; x++) {
                temp_icon.selection.source_artboard[y][x] = cb[y][x];
            }

        // Prepare selection/marquee tool
        temp_icon.selection.selected = true;
        temp_icon.selection.replace_background = false;
        temp_icon.selection.source_coords = { x0:0, y0:0, x1:cb[0].length - 1, y1:cb.length - 1 };
        temp_icon.selection.dest_coords   = { x0:0, y0:0, x1:cb[0].length - 1, y1:cb.length - 1 };
        temp_icon.selection.start_coords   = { x0:0, y0:0, x1:cb[0].length - 1, y1:cb.length - 1 };
        temp_icon.selection.last_coords   = { x0:0, y0:0, x1:cb[0].length - 1, y1:cb.length - 1 };
        temp_icon.animate_marquee();
    }

    update_mask() {
        let new_mask = [];

        for (var y=0; y<this.icon32.state.artboard_array.length; y++) {
            let new_mask_line = [];
            for (var x=0; x<this.icon32.state.artboard_array[y].length; x++) {
                if (["#ffffff", "#FFFFFF"].includes(this.icon32.state.artboard_array[y][x])) {
                    new_mask_line.push("#FFFFFF");
                } else {
                    new_mask_line.push("#000000");
                }
            }
            new_mask.push(new_mask_line);
        }
        this.replace_mask32_array(new_mask);
    }

    render_background() {
        this.ctx.drawImage(this.background, 0, 0);

        if (this.inactive)
            this.ctx.drawImage(this.background_inactive, 0, 0);

        if (this.minimized){
            this.ctx.fillStyle = "#000000";
            if (this.inactive)
                this.ctx.fillStyle = "#656565";
	    this.ctx.fillRect(0, 21, 496, 2);
        }
    }

    render_icon(ctx, a, x, y, bs, spacing) {
        let y1 = y;
        for (let row of a) {
            let x1 = x;
            for (let c of row) {
                ctx.fillStyle = c;
                ctx.fillRect(x1, y1, bs, bs);
                x1 += bs + spacing;
            }
            y1 += bs + spacing;
        }
    }

    render_icon32_small() {
        this.ctx.fillStyle = "#000000";
        this.ctx.strokeRect(332, 31, 35, 35);

        if (this.selected == "icon32")
            this.ctx.strokeRect(331, 30, 37, 37);

        let x = 333;
        let y = 32;

        if (this.icon_drag != false) {
            x += this.icon_drag.x - this.icon_drag_start.x;
            y += this.icon_drag.y - this.icon_drag_start.y;
        }

        this.render_icon(this.ctx, this.icon32.state.artboard_array, x, y, 1, 0);
    }

    render_mask32_small() {
        this.ctx.fillStyle = "#000000";
        this.ctx.strokeRect(332, 90, 35, 35);

        if (this.selected == "mask32")
            this.ctx.strokeRect(331, 89, 37, 37);

        this.render_icon(this.ctx, this.mask32.state.artboard_array, 333, 91, 1, 0);
    }

    string_to_rgb(s){
	let r = parseInt(s.substring(1,3), 16);
	let g = parseInt(s.substring(3,5), 16);
	let b = parseInt(s.substring(5,7), 16);
	return {r:r, g:g, b:b};
    }

    convert_to_rgba(i, m) {
        if (m.length == 0) return i;
        let a = [];

        for (let y=0; y<i.length; y++) {
            let r = [];
            for (let x=0; x<i[y].length; x++) {
                let c1 = this.string_to_rgb(i[y][x]);
                let c2 = this.string_to_rgb(m[y][x]);
                let a = 1 - Math.max(c2.r, c2.g, c2.b)/255.0
                r.push("rgba("+c1.r+", "+c1.g+", "+c1.b+", "+a+")");
            }
            a.push(r);
        }
        return a;
    }

    render_icon32_preview(ctx, x, y, w, s) {
        this.render_icon(
            ctx,
            this.convert_to_rgba(this.icon32.state.artboard_array,
                                 this.mask32.state.artboard_array),
            x, y, w, s);
    }

    render() {
        this.render_background();

        this.render_icon32_preview(this.ctx, 411, 37, 1, 0);

        this.render_mask32_small();

        this.render_icon32_small();

        this.save_to_local_storage();
    }

    select_artboard() {
        this.icon32_canvas.classList.remove("hidden");
	this.mask32_canvas.classList.add("hidden");

        if (this.selected == "mask32") {
            this.icon32_canvas.classList.add("hidden");
	    this.mask32_canvas.classList.remove("hidden");
        }

        if (this.palette_foreground.jscolor)
            this.update_palette();
    }

    update_palette() {
        let palette = '#ffffdf #ffdfbb #dfbb92 #ff925f #5effbb #00d300 #5fbb92 #5f9292 #bbffff #00bbff #0000ea #5f00bb #dfdfff #bbbbff #9292df #5f5f92 #ff92df #bb0092 #bb92bb #ffffff #f5f5f5 #eaeaea #dfdfdf #d3d3d3 #c7c7c7 #aeaeae #a0a0a0 #828282 #717171 #484848 #2c2c2c #000000 #ffff00 #ea0000';

        if (this.selected == "mask32"){
	    palette = '#ffffff #f5f5f5 #eaeaea #dfdfdf #d3d3d3 #c7c7c7 #aeaeae #a0a0a0 #828282 #717171 #484848 #2c2c2c #000000';
        }

        this.palette_foreground.jscolor.set__palette(palette);
        this.palette_background.jscolor.set__palette(palette);
    }

    save_to_local_storage() {
        // Get local storage
        let previous_session = localStorage.getItem("icony");

        if (previous_session == null)
            previous_session = {};
        else
            previous_session = JSON.parse(previous_session);

        // Update session info
        previous_session["window"+this.id] = {
            window : this.window_pos,
            icon32 : this.icon32.state.artboard_array,
            mask32 : this.mask32.state.artboard_array,
            deleted : this.deleted
        };

        // Write it back out
        localStorage["icony"] = JSON.stringify(previous_session);
    }
}

document.addEventListener('keydown', function(e) {
    let key = e.key;

    if (key == "Meta" || key == "Control")
        command_down = true;

    // Switch window focus
    if (command_down && key == "`") {
        e.preventDefault();
        rotate_focus();
    }

    // UNDO - Command Z
    if (command_down && key == "z")
        windows[selected].undo();

    // Close - Command W
    if (command_down && key == "w") {
        e.preventDefault();
        windws[selected].close();
    }

    // Minimize - Command M
    if (command_down && key == "m") {
        e.preventDefault();
        windows[selected].minimize();
    }

    // Export - Command E
    if (command_down && key == "e") {
        e.preventDefault();
        windows[selected].export();
    }

    // Copy - Command C
    if (command_down && key == "c") {
        e.preventDefault();
        clipboard = windows[selected].get_active_array();
    }

    // Paste - Command V
    if (command_down && key == "v") {
        e.preventDefault();
        windows[selected].paste(clipboard);
    }

    // Load - Command L
    if (command_down && key == "l") {
        e.preventDefault();
        document.getElementById("load").showPicker();
    }

    //console.log(e);
});

document.addEventListener('keyup', function(e) {
    if (event.key == "Meta" || event.key == "Control")
        command_down = false;
});

document.getElementById("load").addEventListener('change', function(e) {
    // Create temporary canvas
    let tmp_canvas = document.createElement("canvas");
    let tmp_ctx = tmp_canvas.getContext("2d");

    function hex(n, l=2){
        let s = n.toString(16);
        while (s.length < l)
	    s = "0"+s;
        return s;
    }

    function data_to_string(r, g, b, i){
        if (i){
	    r = 255-r;
	    g = 255-g;
	    b = 255-b;
        }
        return "#" + hex(r) + hex(g) + hex(b);
    }

    // Get image from user & Load it into canvas
    var reader = new FileReader();
    reader.onload = function(event){
        var img = new Image();
        img.onload = function(){
            tmp_ctx.drawImage(img, 0, 0);

	    // Read back from canvas to get image data format
	    var image_data = tmp_ctx.getImageData(0, 0, 32, 32);
	    var pixels = image_data.data;

	    // Convert pixels; crop to 32x32
	    let icon_array = [];
	    let mask_array = [];

	    let icon_row = [];
	    let mask_row = [];
	    for (let p=0; p<pixels.length; p+=4){
		icon_row.push(data_to_string(pixels[p+0], pixels[p+1], pixels[p+2], false));
		mask_row.push(data_to_string(pixels[p+3], pixels[p+3], pixels[p+3], true));

		if (icon_row.length == 32){
		    icon_array.push(icon_row);
		    mask_array.push(mask_row);
		    icon_row = [];
		    mask_row = [];
		}
	    }

	    // Load data into states
	    windows[selected].replace_icon32_array(icon_array);
	    windows[selected].replace_mask32_array(mask_array);

	    // remove the canvas
	    tmp_canvas.remove()
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]); 
}, false);

let windows = {};
let window_id = 0;
let zindex = 0;
let selected = -1;
let command_down = false;
let clipboard = null;

function new_window(id) {
    var content = document.getElementById('content');
    let div  = document.createElement('div');
    if (id != -1)
        window_id = id;
    windows[window_id] = new icon_window(div, window_id);
    selected = window_id++;
    div.classList.add("window");
    content.appendChild(div);
    background_other_windows(windows.length - 1);
    jscolor.install()

    background_other_windows(selected);
}

function background_other_windows(id){
    if (! (id in windows)) return;

    // Background other windows
    for (let w in windows) {
        windows[w].inactive = true;
        if (windows[w].id == id)
            windows[w].inactive = false;
        windows[w].render();
    }

    //Fix z-index
    windows[id].div.style.zIndex = zindex++;

    // Set selection
    selected = id;
}

function rotate_focus() {
    let smallest = windows[0].id;
    let next = -1;
    for (let w in windows) {
        if (windows[w].id == selected || windows[w].deleted)
            continue
        if (windows[w].id > selected && next == -1)
            next = windows[w].id;
        if (windows[w].id < smallest)
            smallest = windows[w].id;
    }

    // If there was no window larger than the current selection, cycle back to the smallest
    if (selected == next || next == -1)
        next = smallest;

    background_other_windows(next)
    selected = next;
    return;
}

function remove(id){
    windows[id].div.remove();
    //windows.splice(id, 1);
    windows[id] == null;
}

function load_from_local_storage() {
    let previous_session = localStorage.getItem("icony");
    if (previous_session != null) {
        let state = JSON.parse(previous_session);
        for (let key in state) {
            if (state[key].deleted == false) {
                let id = key.slice(6);
                new_window(id);
                windows[id].replace_icon32_array(state[key].icon32);
                windows[id].replace_mask32_array(state[key].mask32);
                windows[id].window_pos = state[key].window;
                windows[id].move_window(null);

                background_other_windows(id);
            }
        }
    }
}

load_from_local_storage();


function debug(){
    windows[selected].replace_icon32_array([
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#EA0000","#EA0000","#EA0000","#EA0000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#EA0000","#EA0000","#EA0000","#EA0000","#EA0000","#000000","#000000","#000000","#ffffff","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#000000","#EA0000","#EA0000","#EA0000","#EA0000","#EA0000","#000000","#FFDFBB","#FFDFBB","#FFDFBB","#000000","#FFDFBB","#FFDFBB","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#000000","#000000","#000000","#EA0000","#EA0000","#000000","#FFDFBB","#FFDFBB","#828282","#00BBFF","#FFDFBB","#FFDFBB","#FFDFBB","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#000000","#ffffff","#ffffff","#000000","#000000","#FFDFBB","#FFDFBB","#FFDFBB","#FFDFBB","#FFDFBB","#FFDFBB","#FFDFBB","#000000","#FFFFFF","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#ffffff","#ffffff","#000000","#FFDFBB","#828282","#FFDFBB","#EA0000","#EA0000","#FFDFBB","#FFDFBB","#FFDFBB","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#ffffff","#ffffff","#000000","#FFDFBB","#00BBFF","#FFDFBB","#EA0000","#EA0000","#FFDFBB","#000000","#FFDFBB","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#FFDFBB","#FFDFBB","#FFDFBB","#FFDFBB","#FFDFBB","#000000","#FFDFBB","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#FFDFBB","#FFDFBB","#FFDFBB","#FFDFBB","#000000","#000000","#FFDFBB","#FFDFBB","#000000","#00D300","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#FFDFBB","#FFDFBB","#000000","#FFDFBB","#FFDFBB","#FFDFBB","#FFDFBB","#000000","#00D300","#00D300","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#ffffff","#000000","#000000","#000000","#000000","#00D300","#00D300","#000000","#EA0000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#00D300","#000000","#EA0000","#EA0000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#EA0000","#EA0000","#000000","#00BBFF","#00BBFF","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#000000","#FFFFFF","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#C7C7C7","#717171","#717171","#717171","#717171","#717171","#717171","#717171","#717171","#717171","#C7C7C7","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#717171","#717171","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#ffffff","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#717171","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#ffffff","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#717171","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#ffffff","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#717171","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#ffffff","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#717171","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#ffffff","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#717171","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#DFDFFF","#ffffff","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#C7C7C7","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#C7C7C7","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#00D300","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#000000","#000000","#000000","#000000","#000000","#C7C7C7","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#EA0000","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#FFFFFF","#C7C7C7","#FFFFFF","#C7C7C7","#FFFFFF","#C7C7C7","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#C7C7C7","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#FFFFFF","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"]
    ]);

    windows[selected].replace_mask32_array([
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#000000","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#FFFFFF","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#FFFFFF","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#FFFFFF","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"],
	["#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff","#ffffff"]
    ]);
}


  </script>
</html>
